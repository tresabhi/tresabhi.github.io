---
import sharp from "sharp";
import { hashContent } from "../core/hashContent";
import { sourceSet } from "../core/sourceSet";

interface Props {
  src: string;
  alt: string;
}

const { alt, ...props } = Astro.props;

const response = await fetch(props.src);
const buffer = await response.arrayBuffer();
const image = sharp(buffer);
const name = await hashContent(buffer);
const { src, srcset, metadata } = await sourceSet(image, name);
---

<style
  define:vars={{
    "aspect-ratio": `${metadata.width} / ${metadata.height}`,
    "max-width": `${metadata.width}px`,
  }}
>
  .responsive-image {
    aspect-ratio: var(--aspect-ratio);
    width: min(100%, var(--max-width));
  }
</style>

<img
  {src}
  {srcset}
  {alt}
  class="responsive-image"
  loading="lazy"
  decoding="async"
  fetchpriority="auto"
/>
